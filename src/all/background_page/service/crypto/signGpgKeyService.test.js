/**
 * Passbolt ~ Open source password manager for teams
 * Copyright (c) 2022 Passbolt SA (https://www.passbolt.com)
 *
 * Licensed under GNU Affero General Public License version 3 of the or any later version.
 * For full copyright and license information, please see the LICENSE.txt
 * Redistributions of files must retain the above copyright notice.
 *
 * @copyright     Copyright (c) 2022 Passbolt SA (https://www.passbolt.com)
 * @license       https://opensource.org/licenses/AGPL-3.0 AGPL License
 * @link          https://www.passbolt.com Passbolt(tm)
 * @since         3.6.0
 */
const openpgp = require('openpgp/dist/openpgp');
const textEncoding = require('text-encoding-utf-8');
const {SignGpgKeyService} = require("./signGpgKeyService");
import Validator from 'validator';
import {ExternalGpgKeyCollection} from '../../model/entity/gpgkey/external/externalGpgKeyCollection';
import {ExternalGpgKeyEntity} from '../../model/entity/gpgkey/external/externalGpgKeyEntity';

global.TextEncoder = textEncoding.TextEncoder;

const adaPublicKey = "-----BEGIN PGP PUBLIC KEY BLOCK-----\r\nVersion: OpenPGP.js v4.10.9\r\nComment: https://openpgpjs.org\r\n\r\nxsFNBFXHTB8BEADAaRMUn++WVatrw3kQK7/6S6DvBauIYcBateuFjczhwEKX\r\nUD6ThLm7nOv5/TKzCpnB5WkP+UZyfT/+jCC2x4+pSgog46jIOuigWBL6Y9F6\r\nKkedApFKxnF6cydxsKxNf/V70Nwagh9ZD4W5ujy+RCB6wYVARDKOlYJnHKWq\r\nco7anGhWYj8KKaDT+7yM7LGy+tCZ96HCw4AvcTb2nXF197Btu2RDWZ/0MhO+\r\nDFuLMITXbhxgQC/eaA1CS6BNS7F91pty7s2hPQgYg3HUaDogTiIyth8R5Inn\r\n9DxlMs6WDXGc6IElSfhCnfcICao22AlM6X3vTxzdBJ0hm0RV3iU1df0J9GoM\r\n7Y7y8OieOJeTI22yFkZpCM8itL+cMjWyiID06dINTRAvN2cHhaLQTfyD1S60\r\nGXTrpTMkJzJHlvjMk0wapNdDM1q3jKZC+9HAFvyVf0UsU156JWtQBfkE1lqA\r\nYxFvMR/ne+kI8+6ueIJNcAtScqh0LpA5uvPjiIjvlZygqPwQ/LUMgxS0P7sP\r\nNzaKiWc9OpUNl4/P3XTboMQ6wwrZ3wOmSYuhFN8ez51U8UpHPSsI8tcHWx66\r\nWsiiAWdAFctpeR/ZuQcXMvgEad57pz/jNN2JHycA+awesPIJieX5QmG44sfx\r\nkOvHqkB3l193yzxu/awYRnWinH71ySW4GJepPQARAQABzR9BZGEgTG92ZWxh\r\nY2UgPGFkYUBwYXNzYm9sdC5jb20+wsGlBBMBCgA4AhsDBQsJCAcDBRUKCQgL\r\nBRYCAwEAAh4BAheAFiEEA/YOlY9MspcjrN92E1O1sV2bBU8FAl0bmi8AIQkQ\r\nE1O1sV2bBU8WIQQD9g6Vj0yylyOs33YTU7WxXZsFT46TD/9v89FVPPT+GB1q\r\nBxU1g+f+VyUMW7DCpqfK9i7rLowCItWfoJS3F9TsYfZpLBlKvsP/jpNKUEe/\r\nFW82VhE4zHuh1suCrjs4nF9QMbk4+LstmCy4TzOKMI9RFlNm7bSb6tq2yJ5X\r\nTOKuL7ElXT3EmuN2Rcd1fY+uRTRh4nGETnQm4xHWt/sQd8KnjmdZtegzgf4u\r\ndp0YLXNIdrVaFImR5pjD2OnWCH3cEoPz6SZSubpwoSPE3nhimCMXBJ0DrRv4\r\nFmBdsyADfuA1AKdliOTu2hpAKVRuosxpDEc8iMRMH5mMk0o5ifvjQ3YtNG0K\r\nLeKitpA2BdARTu1axcZLS24ww3vDjJrUjqxhXd8K1+LJcXB+5ieOMbOfmFe1\r\nOOI4sn7aR3Lk6Y1lz3Cl/oikq/v8XZFTAuwFR8fiid001exx2QHpmiPUfG3X\r\npOmQedisqxJa2g6z3QmeXBhseeSLpH+B6RhFJFKkP/JtJxANEBJDRo6FuLvV\r\na7IVstkX3Y/WYQrkYicl6IWMpqJ+8nwX6hqAj2GJhweBfqCGS1o+sA1rYN46\r\nOZ6xDRaMgeKvMUrHdq9giQ4XAqny/opPPKcARDxdSpmaoSE2MSBUocfSDewL\r\n4QJn8cYsexFEg3WyJickZqGuuQ2zuUUjktOoHIeHnZuKyZjcAMt6bEfpWir4\r\nOiS9CfgfFM7BTQRVx0wfARAAwVZm+WzCgL50QUhIGEkvPRelNHkzzgwKfX2z\r\n8guOnp0Y9sK+UZxPk6X/AvjdPeEwvxvOrXwxEaCTOHCwGRRc74TuNV4+O4YW\r\n9HBLlb5BjAK4CbAOKMN0yGt6/Wat1UrrW//ZT2S3l9oRNbxkhgi8BYtrD+Uw\r\ndtWYo5rflkIglZw2yu+iujaQZSSUzo2rUlDJT6m4Y8e6+b7XLBnOkAfmrnmk\r\nyB8770mMxTdcWz56q/otXID9jpPtkrUfyKdtQ+b/bqxK+ZixP/jE1WiwL+Fr\r\n2UUQBqzP+ttWDu2F9+N7gtY5ckGjjSIFOUew1sIazkF80LTCXvX0kMDhXybC\r\nEYic20RMKsbCDeYGUOuTmNisOrkgxWTJfhnpPwV3Z8seZSvaQVzi8L3q0ZAa\r\nE2tsBr8R5oCRYx4XKn9g5bRndfa3PkD6Wb6p68lncdxB37txrqY9OthJVVeF\r\nyXBKTIIuWFEnATBLGuf5rZlOhg2i0uzW4TLq04tsjKEUFA2xHqZNra22R3/z\r\n3An6v2ztdgM7KJtNDJQaA5e7/SXUrSNNEQqUL3XAqSZ3D+UmSNkIgxz8pMeI\r\nHV7t/k10W3HAStOgRk4tW6ainQWNGrMehdkhH04JIxTNSYyykYdqUTvUZ/AH\r\n0OQCWC+gk+iHKKKkn89rDek7K1mdv/sD8+hFKMQuAM08mHEAEQEAAcLBjQQY\r\nAQoAIAIbDBYhBAP2DpWPTLKXI6zfdhNTtbFdmwVPBQJdG5o+ACEJEBNTtbFd\r\nmwVPFiEEA/YOlY9MspcjrN92E1O1sV2bBU8V9BAAwDfZa3h4BL7JeCSvPSas\r\nAS47xnlxkzZh7H3MwkywLrVXXvi39KgAgISoRtCfDpq7to1ZFKj4ZEXGk32j\r\nyqKU9ilPBn4yrrgJSfgcx+6FKv8Mu9LdobIJQGAcr+MtHpsJxshQvFTcNhXv\r\nlopdsuXfAyPFxxqdGwF3oY09ku/79ZRMqXoohDW4QJxhveGcsMMIptEZbcjS\r\nlzoBnk+Jq6GMQC9M3k2l/fS3Ifg6smng6veIOLH4QFbxk9iiQ0/Ob0d6DWwd\r\nFOcJWyj2vm1JfAqJBA46qw5nWTjrP1DtpnOOVd1+UTUbaTWTARjybMTikBMR\r\nDmZ3DlbGO2ai63nLkfFCQUJ4T3dWqM9xwiaaWjyNNriDVskC7AqIE3/p0Fpy\r\n8jfai606K4moTXGZQ37iQkVSk0NYMNZZEjdyGUUpAbkWEXtOVEvguvCTChz/\r\ntVzCjIEDNl0e6+J6DCSi2lVM3y17jyFh9sTXYGF3CDkkY4gDZCL+Du5VjMV/\r\nbw+i5JYo63qTJeeTprtG4Rea0Z9lQLm38SoSbNHkJ+vfjVmlVKzTENO/Jxfv\r\nBik+rx99qvYvX6Vd/F2JcDPahGtIpecH60sD7g3eb5hoJPQDpUhM2NrxNZL6\r\ne5RLdU3W92XwGozzDtyKL+XcL5tM4SQ0BxaO0hYuYx9D4JOGwHfRwZgfLIqM\r\nS+E=\r\n=cqUt\r\n-----END PGP PUBLIC KEY BLOCK-----\r\n";
const bettyPrivateKey = "-----BEGIN PGP PRIVATE KEY BLOCK-----\r\n\r\nlQdGBFWVIFEBEADNf9iYgEVVxHAQ06XTEtx2kpm9jW4kiwBUeJxDEWnUPACEW0Qn\r\n8qA+WAAMeFppxGIjkxW3lyI+TfV0Cclw7h5GTSMlSlIosrNqFRDvj\/q8ghZLAccy\r\n5rcpHfLwHdmGR+S4qzCxfJQ9rkBdZQkde4LpRDmbx1EkFeed1FXwoNuxFfp7cBoo\r\n\/Z5if+mf+6pn1oLAy47PlASYltPvtj\/pK3ZNBatPz5vfBVRjTH9UrdXK8ZjnWypw\r\nACln7pe1vz5mAmNJdpPhxvAMXMx9zWEookYQFCaeOKI9t6t5LX9Vn2wAfHqLV94P\r\n8trrBRHYgAjMI\/fIoOXxcSBEBM98AeJMgMjwQ4\/P1o0bvAhxitNCIgqeLtW2bR4W\r\nG+8SF6ALcZM1kGt8a0DSC9X8dtHpKSvoCT7GgCXtuMl1gptjprzHnM1thhSXZyFI\r\nmVM3e99MC101JG1pQpmyC91KyHPWcwZE\/ugIZTsJQwSjPeLHcGbp+5cLOWArH64Y\r\nVdiUkQ0SwPdB1tsUvfekoNBWQgCNAL9yFTXOsxNM9AsZ+r55kQvp3voMdt49n6z1\r\n9P6sVaPa3+7yj1W5LBIV0stgxixbXBBTnAx19R+23FnmecfHYH8cIiFwJsYWsAYB\r\nCGFzhP9kYzU7Io6TXAZ03LY9KGZW1aRhZTUuY+JErWFYr\/D+9skZ5GE1bQARAQAB\r\n\/gcDAvpdLMN58+dB5Ff26iDBZZ9qd7gqHSfy2hLa+U+M10QmhAugnaAynx+y36GC\r\nhtd1wSXG6mStR9IEDFkgbSuZFGWkXOvvt5gZoKUx6jLkoMiy7VubBwlhyRb6JcjJ\r\nyHJfVq6uVqrxvbUi9lihPat7A+e05b7RoscZEzO3Tc1obdzTaxtvjFWvahT8ShOA\r\n0uI4agFETnWBlm2OcuOMpBYhbft2sKjrfO6Pm4OsV8d5Lx2hfiZQ+9uMsoTNpo2W\r\n+3sAzcrcG3jBGoKM6pnembgc0C9lDfY0ZcAIlXlhScG2pkfrj2I22Gyq7Ln\/oAEN\r\nSzqwwwCa5O9a4\/CXpoRZtAYeu7ldjOXMWRO\/OO3ShOx\/ABJrgPx1QQA5Guk2w5dl\r\nkCc2Sndq508KwGY6DnTzV0ynfpW6ex44PYopmI7bgmAqRc0fqz2E3so2vZ2LPmBD\r\nkeHdt0U407zuTd\/hJ1GOFsLTJZ+ksVOJcYyYQQbScS2Eljl4G9xv2iIQt+xO7w3N\r\nqga8oHL5L2P3BKC7QxzoHyi1h9gV0pGBN0jgTmMvjp1ADI2umewlnNNUCGqpHzse\r\nmY6JSL+kDm0k3W5msLgGtJGe+X6WAQNQ8++OF\/TdVJYzvWbtEnwNkYBjopckLWvU\r\nKUjch6MqrCshdhvoTW5xAz2Trg5L55Lb66b6Ss6KTH+mxgTytwwJY0wt4LUCun5Q\r\nqOTmab5CYmTGifHLkvxq548EfhAV+TqQ8O1BG2uh5qbplYXkYjet\/GSWYoPrSCBh\r\n0qNsha2fijl2SMXZU1mbM+KumEpugU7cQXGwWZVtOlK9KffVvDjJ6UDSNYxdTjMo\r\nAPC8HJuX01Ay6FP1SKi\/RIPRvh5M4VMO7d9OHXT01dPV8i14\/nzNHofXFWmWGmev\r\nIoCtzsW6EkSbCCrjT4\/yzS+ysQbr5j3JPqaSMJeTBLzQevzY3fnjZ6e\/40mCWlzd\r\n3N3Q+V86gpkc7GKfQUOLIzffJ1RHSBfZBLMIWTmd6SfnNQsBX9x5QOq6MBg\/3dl9\r\nvm\/81nsQRH\/0Mh2NEjbE54pkI3OAxrcAd5zqvkT8djT5oiWNkJhhVgK0QSYPcGYH\r\nmVfgZ08tG4GEG+mNg6o9MbWopbMrTAA7pRcCeeRtM2oGtqJZBIGNXXnn54uWLu40\r\nZHpTcNmYwWuUqZG5qc1sM9bBFr7dle3bJMbZ5nS06i91+kRt7RXxPmO23gMcMqTS\r\nTzn4Hdrq5zR0d1c4CqoOZA1IVDYjD\/yw8XmCV\/KmDwshiTNi+OPSbbtiGz3F2DYk\r\nLQprU5DmIICYG0FaMg0CilFUoHFJgWECotI89HkaybnwoZoGHwVf3qx06cPscZ9Q\r\nvTSxoelU6Ve6IxIRJcetYvHdaAhdtTshe1+5lILb6engnTHGtIl4gKzl6Z69rig9\r\nGC7zIeJGiHn47br5c9PXCZNhHtt4c+0NvQqgyVIgKgnd2sdSR62q8lFbbqIbd4vo\r\n9d8+lEdsZF6pHaMxAhYGFABbmCJCdWEQxNKIg6ziAhAgZBmKuKRUeHom0\/ZmUbDi\r\ntzeOERgjgFwi2j78qSjSn0rZnkTYVDPgLajLBO6NIbdESqCbcduF1LoZiyWAX3os\r\nRiMWTyMj+sy4txL+RuBbAhjYqnyh9M+lOFP9TlPyrSt8VpLNo9fVEFp4ExV9VQ2\/\r\nvYwhGUP8HDnxSchX14E1snnmL7mXKz1JRPcJtJlQDOQb36A8LgXS5Zq2jQvk\/Vd2\r\n\/oMu0r7Qw40txGzQKzdctHKDOtsp6Qycm7PabxPD\/xhzR79yRrXuOiy0JEJldHR5\r\nIEhvbGJlcnRvbiA8YmV0dHlAcGFzc2JvbHQuY29tPokCTgQTAQoAOAIbAwULCQgH\r\nAwUVCgkICwUWAgMBAAIeAQIXgBYhBKdUhgw63lqwRZkCXtPx\/kvmHXAJBQJdG5sI\r\nAAoJENPx\/kvmHXAJLuEQAJkxKy7rosbSbzvk7Dh6K8ZBonwJK08YBoaGOB4g1ScR\r\nZYsAF9wYApiFQJ5F4pjqwRIT4SNLuKB6quMwTZjVaG9SC+4I7PW7wSJXiyR57CpX\r\nRx9lHRTYdb2fBqk\/0M2kRWNg+dxOyG9thpTMX31EKPmTGlzLhVZ386dpxt5YYXbB\r\nyuzLpf3OxuQDMfGOrQR8rJm1+eXf+AxWFovTa\/tD061PP+2jRws+ebRhJ8Kl33X5\r\nOj29dCzPwHk4AY6+4QncmLMvfQT\/FzSqoj8yfo20xKyhjddke3nVzzKC1Xk9q8wE\r\npfWS2neFdH6p9egzLl+RPzSE27yB7I3cdxGNhZJqz\/SVXq2ziRkWumtsfpdvbQ7S\r\ny2I2sPQQzhnaFSFBOD78g6P0t7IGL5elHHpLV\/bTq7aPgOURy8twUJSrlEdipzwB\r\n+N0mxoLe30GSYjzMIAk0z6rXkQCRiFV97OfIvMq3Zq9ABH\/tFgSW3gdfaZ8hrfy8\r\niqOX+FwiAg4VGEsb9z5qMwbSLvHC3lt9+5mxfCo4Fkg9NL1EpiObAnTNNRtNHFg4\r\n0FHd10MF8MObf9thyd+omUCkkR0HN16a\/tK1g3lTr5hePGbATclHv6H1r4ZiFDiv\r\nqkGLVDyfr2c5K1DL+KSBCrh3OuXDSNihNyx9iFzW8MDcan257oJVtGf5SgjrUy2b\r\nnQdGBFWVIFEBEAC7y5b+FLndxN3qeQ7jqCXITkw56cYHBfqGz7fc5UNVZLBkmQ7d\r\nT87rFWyl75KUxlj5sqgOUusiPmoQ0W50DBWar5C4tT5BMTrvcUPlIVk\/UO5N7YeO\r\nijezTGYt1BB6AQIJkGeJbCcubOmXz2jC1uuWL6GU3vxVhh7Mjp6\/1ZP8lJBFXgYg\r\nPFs+Nx14sk2KzOlwlHGftJVKiBhrH4bwKMY5lEvRlACaqGLTH80lLtTaSI\/oHA5s\r\n0Y\/VtObAgFrpUXQ1YLTvGdQMneRXRI5PXoSxHwb\/Qe6rUBh7tO8oDDLwDTHyB318\r\nu8iNI5YvS+w69UTMa2He1lmOYwSHArlmkDnvSAQmMOz3NjpYKdHiqYSiwd1khoHs\r\nMb7PIGbQbiy4kAAywgM6IF3IgqdtBEAt6AaK1XC\/cgdN9EpokNMGsQZ0x64TS4cy\r\ntHe9AxYMBSPZzpRXY6sd4+m5xlgsiPXWzbGWGGlt\/bareEinmNDmqybX9cqhK7Ja\r\n5jMBUgqj7soMH+ssBu1SyudFr9iyDDICtqrk1oFwi93zVoO2izEps7UPcEJZ+rZO\r\nQdHBNVH8+EjlEnXLf\/rv7VD5K7W\/YyrD\/DJ+MgxyKhlwNJIRlcNXOj7wnmYgbfPh\r\nyRZxjsvAC7T3JX9FF2R4+8zF7QbP991Q\/VW3hnRbVy47A+sjYwH+CclqKwARAQAB\r\n\/gcDAhoj8T\/UFj3p5CO0XXDZa6dWbhRNxQYsvYM2rE5O1CQ4ZIcaM0VU1OlCm\/9A\r\n2M06vwEW9Ph74Sfcw\/THt0qOkR0R5KK4AC+60nfd2O3O7Vb4HbFz5KLWZCyhBxF7\r\nKMCb01OEXyjR9PUwfNduxl+UwN6MLDvYK+okgOWGqAWLgBpbU1CTwvqLBa4Un5NO\r\n7smOJND3DV2zRtDhUwVRoviR7VKY+6kjEab46nTZEFIxFZr9423yj79nWAykybEE\r\nyLoqg7vI2BJBjlNyRxcI2EZhUKZz4KkQ25EQXBJIqGwxSdE+x8AqT91g4a7CBx+f\r\nwUkElSI4VTBZGuy9a7zxOt2eQ0s79kofoga3Tqr+POx4v7LvuHNKNhwcgxCTcnys\r\nAicAv4dDqYy6UvIDgln9sNB+a\/9mXlUWnvvSL+JNZbrM7oQRaujxUAX80NZaMX7U\r\nDA+Wpa5cpWE0ewiQAnXIYPDqf1qInIyAnVNDnBNuzWmYY5971OVv1Jvlk0xMl7x0\r\nSM2JNKR9ctxO5ySlliDmrebOnKYPPGy9E4qApYryQWvXdlcJCUm0YtRO5Adl+Apf\r\nbTYhsI\/XZKvCN7+G3FecGA1YM9+d+2FsLkFrrRAvqkkVbGKQMxBi\/\/Sq3sEycUry\r\n7UxIfGc0h9Y1QSULbOn1ymxK2GO4HB6kS\/SEOgDw\/PI4YjIpKCbY0vxMfMvVFF7v\r\nicVTxC61AZjIpbZ5GPiX5RKpVcBNzxrQ6+9DumQBvmMDjxoxAg6EtHax1KBs8QD4\r\nnKp8DKDdiLVLSUu3rHeS0S35lu0T\/6UIeAhVIZrWEOTRUZi\/MIbfoJ4Vin5csXA+\r\n8pB1q0TSKr+sbSzsWRxNEHYbJYko64ti+5O1hlDb9wNEBUdie4ObFX0H9Ngsv\/0o\r\nIzCwbSPp3quHTzTtJTcgJOdXcUzf3IWL23PN4DJi+8bqELGp48\/S8i2UTdlrXtKK\r\nPa0evYboB3Oq4jel5DzgT1S7lIT84ZjTQLfL8IOcM30S9f9FxzSmYTmFv\/yB6aKJ\r\naCVLCoQg7oJw5F3NdBhKkyQ27qKno7Y7\/1sPF42FnAtoxu9VLIsQgDyXE8\/XM\/1J\r\nhkqXnnb7x2wUkiLBeQZHVJ\/yKGiyizbexmFe6W408UQ3AC4a53m0St2bQn7vq255\r\ndt4GIvs\/SgJYKD2VAxEvsei\/\/wus5XgHvOWH5NCWXrSY+b1TNK4gnrwhdHPZUZ4I\r\n9uHG\/TGn1ieA1wmIPv1uXtO+C\/GBM1t\/gKjopGXWKZwV\/ugx6ePGfsTfMVeYl5+i\r\nNUGJPPkwqMl4jlzRKJOInMGh3mU7Ev0Z3T+fxcUMcpJVOaze46cQe85EiYugAXCf\r\n6pI0gr8FVighXFZuBS4bT1e25HKac3DL1c5xrC6S1BQRgdPsNEsMfzUtv7tcWJNM\r\ncpqlXC0GkKk+0208t3yQ+qolA4xXudYIp3Mv9PTYSm1mig3uCY0XKa2T6e66trna\r\nvet4cF+WnmpsFbenZZDf\/uGfGxGRAXStF4P9thQTFCboqdCZFL4V4Ph8X7VGCVzw\r\nFQmDk\/r5WMCp+N+EW1p4SkvryZOy4Xaxa8aMSQUEy750ibqEjZy3kML\/xHLrwpx3\r\nHOPADN+g7W1Ew+ZMbAC5VaoLxgS84VyO36CCFOfZn5\/QVWCL03ljrHrrV23BDXv0\r\n0UCBKwFNTkPL4NXm\/j+svtodJ8MC3ASqgJ5vE\/KnLYYTZKkobrAufANRBHFqKoUo\r\nHmWjU+AaSUNZBxyCcJ0Ma1JGEonsDigncWSDxL2OxTi6F+Z9jgjAJ6mJAjYEGAEK\r\nACACGwwWIQSnVIYMOt5asEWZAl7T8f5L5h1wCQUCXRubIAAKCRDT8f5L5h1wCZ7f\r\nD\/4jmmppbAiFqFoDH1opIqQIfTP8X78WORNqlhYQx6hbp6FWWLl3mfz1\/GUa4YK+\r\n8K75Ol2JYrWx1or6Kvc\/4HIV9ZfsY953Fh+icK\/FSUSlk2xcY+mL2zeYFI17JNas\r\ncdKC8VQCzyDSF0bqhWSUaRB2xOO0t4wtVTfhtmd\/yTnKGJlwl5ceuhAPeQT0cUmb\r\neuR1hAP8zcqsEdGWpBtJp7i9eeAPgT7DXDNSN7h3wc5hmwaVtZwu1pm+POH2ZVcy\r\nHAFLAaHdZ\/pyF1HFZ61g\/M8Kj\/we5YWKadaM2\/PrxdYSAw6\/wSTZWVueq70io5SB\r\nE5Kio1giMTgfQWpp68cXpphFn\/Nmg6LI3RpoMB62KX4AzAK7Z7Gftn1QjhoIJifd\r\niND\/M3\/agoklhoNP\/Mc3+EkuU31OHzIyFansR4jil9HIum0Dl+VXykWjzF9NJY2\/\r\ngRM92hSou\/5YIMUgeb0yaqYp7Qm7NfNqf\/A\/WUw1cihFUCCNCT6\/lXcBDtZptMDK\r\nuoiHts5SjPao6qtk7kZrDUu0FJ4oxVNo95W35fS3KRD4sFU0SB5EtGlHP+C5\/iGj\r\ngFKLw0jdIy8AZm5e4B66fq+yUIDxECPD+F44xJ3a4NF9uB3ZVOAABO5yOnWXhn\/C\r\nBF4+ZP5A5CDEiZjLZtnl6SWXD2Bg1VJDgN9IqA2NeH1WPQ==\r\n=G+S0\r\n-----END PGP PRIVATE KEY BLOCK-----";
const carolPrivateKey = "-----BEGIN PGP PRIVATE KEY BLOCK-----\r\n\r\nlQdGBFWVH5gBEADl3Pyvzhciv\/+1k9PL+c+Yr5sasPXJmoJwQwBnvbJEgrVVEPj6\r\nr0gJeZmHb0cozL1wfUkOAR9l7YreJ3tNsh7y9Mz3RhICVc46MWDAu\/mQMFVLtaXu\r\nhoed6Xs21jotfBq\/2KZlxY678bAmQTDPCqrN5Ehnt+1mwsSC7DG91A1A57sVyV3C\r\nJy1T48mLVrggF8iDuePGUppBYzvoW9WpFdalhN6+Ni3VoTlSv5Ds49805eGlHv3d\r\nsubTUfX8HBSlu3RNPns2qTn3CQNTq\/29DFUN\/T1rGDdRYjCIKkxdwvtwDxOHfLSK\r\npMtQ5yNL2dJdymsiAGXOLhGCMVVqf91jePTAsjIlKaCtxG\/q77OplLm+SksLBXkO\r\npROUKuhlImu7aymFu8FrSvEMDIWLbhBavku1tPgQyxF4CDLQiBxZNur6l5xWXVEo\r\nqpNLsiICsYIFDNBSJy8bQAwoCBTz3tAwI0QZC9G5qFzBkxye6qNbbTGMvrpaM37Y\r\nqXPkM+i\/wc1cs\/FDqYIgwV6Ws3oIeuulyp9qImJ\/in89DW6Ls51G7lni244Fqgn6\r\nvQLtFf4XeSmtuRWrUFmPE5Zuv3Dn3G2Y13fN2fFVgaCjH6J1UVlRLobvM8QHWDZk\r\n+sLsRgQSWaW3cMJQfZUIPCM\/lreLJ3SgW6nKMu8A0EQp9BSmNoNTsMo1BQARAQAB\r\n\/gcDAoYtQB85wIBq5ClohDqfkU5f6E52XkSShO4d0iE3cxl\/6zPpJi1mrc7xUGEb\r\nbUF05UlV0OT\/rGEK35lVGQHFSGK+UstQ3fYPZb8EDhkKJ2RdWfXstr3TicfhMs\/m\r\nmM4OlCAi0L8Ivak+rXtm2uxmGqsUzSjOiuAH87feeug2BEJSzTChLMHzBTrJfY+\/\r\nkYOS+jlRltMXye0yjpilkXFXlbd0C7WmL6vudCNPx+We\/A+IfJuFFtOHv16JLbbr\r\n1Gr29+oNF0YaT5dfh97Vt2CV8kHftvY6YYSfCxycj867NeEKlKW7UKjrAiIodoDD\r\nmAPh9jwHfK6LbOaxLEcqsllrDyeiPWL4O\/RA4HwC\/CVs7aZ9SIYccltviDT4f90I\r\nlFl61nWa7OeqC7iC1AVEKRxooBgmxk70QxcZFgyPW7YW9Hd0lDW+SEelN3Vh48pH\r\ni\/2TXFpZc5X9z4cXM\/fA5J5XzKffbcbht2AuO6GZgrpYVt6yHfjtagchgQibX57T\r\nNyqwV7WeriJ195\/A869SsRu2mj+IA\/J2a9\/eRYph6TmG8lMpulOP7iQTbhMxeX8O\r\ndQ0TzosC+3q+Mkc7RUm+b3njyATewgR\/ZYhGVmbqVOu1hx7PN3ANLZ8HQJjARowY\r\nDiQMe7+VoxCed9DvcawvNlPJ\/QuQ35XDwGfTtJNMqxHnOCdyXHH7TNUR77wqi0VM\r\nS51pRK4q27zszmC3qxvTh7t7l0eUmkfwEkCpv4OAHBS3bULKEpvkoNt4lA6mclTE\r\nQVpUri9gWv2\/Fds9jeuebq5S9Bd0TyUA\/iplgXCIO6sY7SzHxA\/ShuhDPt346wpM\r\nwVECwSEGEhjT5pgZQUKSIfxWQGfJGNMbb3Rq4IkNNTCkl6ySv+2A7CBMtLxKaXxz\r\nbmLqdifNLIFMt207VxHTLwBPK8KKuMQUR8oH8RZ8qPLG+Sf9bVbWG+N2mGK0D21Q\r\nRfkBabpDSYX7NCCHM\/NIYbGKlV5dxsgJaiHnevVbEfSGQjWhy2nwg7X9N\/OGN8YO\r\n+XdGahvfVo+F6kGXNAzvvZ+0O4l\/amrJghKLLNxTzZbeVWNRBskrBBxjywEF+H6T\r\n9M90YTd\/P2J4RYodGnEascfrPZQ7KMiz\/Phz5Ww1DIlWxzANpz4WhVbvtJHFI7zO\r\nXyFvixjDrX8jIjsOQPxvlGKoRWPlWVm99bTGprkKcy\/wMTZFz\/BWuNWLvy\/K1Sow\r\nwmf+hfi5g6omCJT\/elnCGT7MgTuW8p0mEikSMhVxOwr9ig9M2g9lK9zUgdhbTGK9\r\nzOdrwa771SjUjIAxQIKqFsvBq4IKGO1hlcl1FlWpg\/E7+EDhox6hRSltZ3QDIH1q\r\n75pD+iJIBD7N5YZWo1GcZm8OwbTfmhknJQ+m9twxgvsUapagVOz82IA0DuD2rMzE\r\nBKntfw9UPwWixZv+mF4G+D61wrMR6JJ1CUWtVv3ou4noWVGnR\/1d7iBhk9+qmt6O\r\nYM9cUW2aJvQSCM9\/xG50BZsu61pSYpNUThcpym52bBCyfd7JSA66JnWa9BcZCVdL\r\nJv+oRiBaUqJsShFE18NdjIIviMmHD6vzSH4Q5p7PmyKb20s9NvMmtP8MIMjoATtp\r\nART4qOXzxgXOmIWo1ndfbTAsv4WmcOwp9mUDw0xX9i0ZuB9Rc+w3C0UyN\/pkl1RN\r\nOTiiAt41PPQ\/mbN3plMPHJ\/DH7dTROdJpfm9tslbiK4KqW36cXrA1ZcTFgxC2R+d\r\nEDT33DelJn\/rRtQs0lGm8lsrl0NXD5qBWcM+t8YBQ\/qbxRSSs4IwNY60H0Nhcm9s\r\nIFNoYXcgPGNhcm9sQHBhc3Nib2x0LmNvbT6JAk4EEwEKADgCGwMFCwkIBwMFFQoJ\r\nCAsFFgIDAQACHgECF4AWIQRX3n15q+czojXrH4TN+PyGgpRdPgUCXRubewAKCRDN\r\n+PyGgpRdPqPGD\/9x+AswsEVXCgQUfXkz9qqZ0WO6WwOEoGnCGvU38MO8zSdh4qfI\r\nZaV0m\/LwK1fnKae8GaDiAu5Uq6LFKfKNw86wqUUQUv6fz9GvEpaaywp2AwunVT2i\r\n487Fd9k+2iAIDny9EtMvh0zuGboubm5o\/0TcN+kf8iRPMHHwRl5viwZsoPVO1Lnk\r\nBUS\/od1j0pRv5yscJ8BVcHl20p7N2smAe2YXUeGDw7tQgXk22wsxVKmuGZ6nE4rt\r\npg5W5Wk9ala\/zg4n\/MQHHWetpOWv3twN05aEUSlI66DhCczLYghiq+PWc0JXkVCA\r\n94rAvTwz6ZH73F68N3jni5YwVqzOfQGRjs22Z1nYA+Lxxa3qJHDI0aW2D6B01xV5\r\n7eunZRUqQpJ+dyflvZ+ecLM0PtqwjPY3n3yLIWrBriwLAsEuYXLK54arW4xnmk7O\r\n60pCJKscX92VDqMbzdA3Ack0hEIPJKNdCCekNVAGw6QdzjRm9mMl+Kw3qrg9znab\r\n\/SEriACJOr3feASYQZKrGfIIpjr2bRBHv\/lPdBcU2qXE4gfk4z4cSZZPQP\/w2zK\/\r\ntUadRLP+3YzGdP8+hXYZboCxfkaiGouDCwAE4tpVBh9ee9mrhaIWcdGbv7FXRd2Y\r\nj9y+tF4PqhfxEwkU3gPPRFIzAIPBAmJFPgCn0vmyZii4WPK1gL7JOEYEhp0HRgRV\r\nlR+YARAAoPDtzyhwtZh0zhmTqhoNAGsC+NUC9FXDf1+sjyTOhS5FCoipGzfrOiXa\r\nr8GsfDEKJXklD1Vnvtt2Xxiz92fqZN5N\/0hL7o8BTTQbtPmGK8td8Ms6wo4DlA40\r\nutJ\/l10WNg6NK1RB0MAQ+G1ViXTcRXawiTbEVkLz+u0deBQcITU0ODWufchaEVK0\r\ndH1LOn2lSnCy7161Wjlv6VAkqCYM0VMz4pKpw3KGtvgeTN7VN30ONmCbyoEHbvIz\r\nTXVpq9dvtQqNmBJnRHqgUjHrV9Q21YDQ2ZiHj7mvRjIy7KG1F77pdFZKP7AfV9sa\r\njQXbY07jgBrH1uJ0RiClr2XbDm\/hPaqLyQqMxeuDe6prLr0hO6uZNwEnB+a0vd42\r\nCydDwPvfG3Zy5KSqhnNJEloLxqUli3NY7w9C8LJaGJFMl1xGC4UlrxO1UqfoN8nL\r\n1\/oV1VqLA92eu9eQsL\/jAEjgStDvMHjaoIXywdTlp\/FKp\/ivsbzKt2Hi8sW5Y7QY\r\nGhVUujewwrlZWSokOhhJPFgOrK5HuYuWR2luOoUarHsDy+AcreNLWe9eqAoTS3FY\r\n2gfLWEjKESVDFKI3POqMqDtw0HLsDtYFKMC6wxpjHnxwc76rqZbPA\/yUXVXqd43j\r\nDL4E3rLArFlz9pzBCb41waFnxF2vlAQHMzcx8azXIrOTc3VoV18AEQEAAf4HAwKB\r\nEjSPWv6npOSnxlzX9z1nd3drFiG0S3ZeOx1kPO1FuH2VBglnZvOIeUAMrsqyZsil\r\nvIQl41w1SU49D3zbDFrZ4fUcsoamppG02Rcjn9tXPP6QYn\/p21yx0qoYmsU6EitI\r\nwTLrtifzeMBCF6SKqKbAmJTeC7O4jQNVdSVveBmL0GlkPwt6VW63f5\/XTCN\/bFzy\r\nGO6Cso5heTmXaGWe1rSfsD4dUqfOz8XERyZgTIErYbWILovwcImavVmtwtnzTVzi\r\nPCIhXlZY2F76HUhpBV+EmVc+3CoFz826iyygldA7HhB\/GpiW9FQypZYNianmeLtf\r\n0EqWP9ptbABDB+zNFWNpEj5jZ7uvrLrkSBlaagrC4i+nTPP3nCHYHHc9yK1oVq2w\r\nppxpdoFgJmAZZ3Dd5PHBx48zCmD0WgTatzMUWlmXUYaVy8ylbfD8f+yixLTxC6yx\r\nKqqzbvhZb9ZJxtUnXWDU3Z4OGvvkpkgrZelZy0OaVGNaBgusYaCil\/R1mZgYsAt\/\r\np7ckV8B9F2t1s8\/xT8Ui0LqoLhU0\/K862DvF1m9AJos7xzAyIVGrKg4W1Vk0p1h4\r\nZq7Lhb5nTAfEn1z8HgGMmT9iQ9rbCQ5fi\/t40lKflHwZOVGRM\/8HA5rjEbWZZPdi\r\nysyf\/vnMkQVO1126zbDXSXdKv5rypYYuNkYpZCszS3EEFH+2jWm4C7vxO4ZlR2IX\r\nA1v9E6u65+qsNDGVivCga+WWk7+tE7FYZOcj09locnCxJNzlpM4sBqdWz2GOLi5x\r\nC5r82PCgTyVm1FKl4t\/K1gWR4Vu3lj58UPK29JnaDVhSDLTe\/1W6gwJSP+G3+F2b\r\nDi3M\/cBt2eg8NnTDGLuv1O+OkO948CCj1TV+8aWRueQarnkw3vw+q46IQy9VoX5R\r\nNHW31hNllPl1gi\/C7g\/GDD7Hz9V1M2ptyfqjKB9TEjjdW8gj5ER037SHFBWP2pCk\r\npja+sL9rIDoWa3L2TaDpAWwd86T4qnx0wymUVwXSbv3QU3ZjEDVNEoJySXwAHemY\r\nWaMhjdE09i7XWHvyORFF9Oe1L9klUNGRxHgWCNlgui6FgzUOMqgcCEUrsF1Zj\/7d\r\npOgs4zVN9VLRl\/L2PfWpwjhG7GTnjj3yLrhFN5O4lO2MSsyoleQY0+ZxALi9\/BT4\r\nk1CTSEtlBvcWDzY9Nhswj7jj2v8wUg8rasw+MVJuxKJL6jKmVqfGRnpDFmtTdi1C\r\n3AvgtV6N73uZMi0mN+mUn8NUYwSE3P\/FHsfs2PQUOMaaHwrjpiQpi0C8XvMF0aCN\r\nxoqEglDJlT6ikFECklx6O+7PIqvOubXvsHC63za4a3icDr0NfqEUPO43LtndHPpF\r\nAUqa1YlqLHfljBbopGIeV+K2M4jwvpI9Z3XV5jP5Q\/9iSwqheZbdZiKFfpKkai\/a\r\nCz4VWGhQ3+pZx+1MvHfV6QxVaLljF\/nowYQAnHOqrKo0yFCX6dg5IgEjgHNqoci\/\r\nYYp\/tIUqai\/uHXgDp827ALTyjsxh\/c7QmdQMOWapeoh1bqyjlUa1saG2BjaXT3QP\r\nsjGydfLk33mFyO0gllPmG0s0H8nWlWENTvfZ8gR+28B62wayody7ng09LqOadeIs\r\n3RmEdd1C6AYI1OPAnXCeIjOrnsSxtSnlQqX5XIxBKhDWdCNMyljuDKkPStCvgnJv\r\nok7ITmxW5qXAR48N0iMqKJgtVgFNUI7YLkBqCf4tgVN4VFyY+mtDlXbvyMelpR5l\r\ncwB5Ch\/cUM\/8wXZGWrrv\/bq9mh5KXwpC6M+Nqu4DZwr0HcZviQI2BBgBCgAgAhsM\r\nFiEEV959eavnM6I16x+Ezfj8hoKUXT4FAl0bm4cACgkQzfj8hoKUXT69zA\/8C1Sm\r\nnJx0wTs8Xa1udvRxcxEiFCNNkEPWF1pbozPKbG61Y0DXoWCePOZrw+AVaxovfIGx\r\nhZWzm3ZNDa1s8IbCkiSM6gWcBnCm\/B3EglXDTNrvlbCyByB9c61DR6M7kkRZD213\r\n3lng73aH\/oMs2r5LAVRDaV+RXHUja3Hsw3HnDFMgEDAxqXNmqreCEtZY8twiJseK\r\nZ6\/n40lYM7kmzQ03wRSlDJpamOXoFb4vXtKe2ucIyaGmGJQs7CmcMV2cCHBRzJYp\r\nZyXURq9v4qW0t8i65QnqlGUDEZPta4bD+BrYoagp+g8C67bWCsvc1gnCg3p1d8Po\r\nA5PffVnh3MMId8jIy4wfgE72rdLw6zHVOmaDwBoT8OOfuOF00koi7e34up\/575xE\r\nsl2zfteFl5w3miP6Mv8oVLwRN1ft+AyMYgayJxfBs+IPcK1t8\/fGCFvzpRsei5Nh\r\nKdSmlLqDWacCYRN2GrXcDqd\/K4Ul4tn15HO3UyAtipFxtUKh6UCm9eCpUxiwSqbV\r\n1y5aptrpLLx4EDif98VAuyEOR\/NiKcAyJqwyIw29puXv4pC2fByTE3zIn\/\/rk7a3\r\neqQy+l2bPf+fSk16euLeyOezVbZS0dLXcNVIEy4iCrlFXo2ROuNq95+kKPvT3AI4\r\n1+LqH+uTzzoITWJty0Dn\/FzFsZ0\/kAPgM82xKAI=\r\n=Isas\r\n-----END PGP PRIVATE KEY BLOCK-----";

// Reset the modules before each test.
beforeEach(() => {
  window.openpgp = openpgp;
  window.Validator = Validator;
});

describe("SignGpgKey service", () => {
  it("should sign a given public key with as many as private key provided", async() => {
    expect.assertions(2);

    const bettyPrivateGpgKey = (await openpgp.key.readArmored(bettyPrivateKey)).keys[0];
    await bettyPrivateGpgKey.decrypt("betty@passbolt.com");

    const carolPrivateGpgKey = (await openpgp.key.readArmored(carolPrivateKey)).keys[0];
    await carolPrivateGpgKey.decrypt("carol@passbolt.com");

    const adaPublicGpgKey = (await openpgp.key.readArmored(adaPublicKey)).keys[0];
    const keyToSign = new ExternalGpgKeyEntity({armored_key: adaPublicGpgKey.armor()});
    const signingKey = new ExternalGpgKeyCollection([
      new ExternalGpgKeyEntity({armored_key: bettyPrivateGpgKey.armor()}),
      new ExternalGpgKeyEntity({armored_key: carolPrivateGpgKey.armor()})
    ]);

    const signedKey = await SignGpgKeyService.sign(keyToSign, signingKey);
    const adaSignedPublicGpgKey = (await openpgp.key.readArmored(signedKey.armoredKey)).keys[0];

    const signatures = await adaSignedPublicGpgKey.verifyAllUsers([bettyPrivateGpgKey, carolPrivateGpgKey]);

    const keyExistsInList = (keys, keyId) => {
      for (let i = 0; i < keys.length; i++) {
        if (keys[i].keyId === keyId) {
          return true;
        }
      }
      return false;
    };

    expect(keyExistsInList(signatures, bettyPrivateKey.keyId)).toBe(true);
    expect(keyExistsInList(signatures, carolPrivateKey.keyId)).toBe(true);
  });
});
